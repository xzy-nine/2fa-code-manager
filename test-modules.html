<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡å—ç³»ç»Ÿæµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        pre { background: #f4f4f4; padding: 10px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>2FAæ‰©å±•æ¨¡å—ç³»ç»Ÿæµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>ES6æ¨¡å—å¯¼å…¥æµ‹è¯•</h2>
        <div id="es6-test-result">æµ‹è¯•ä¸­...</div>
    </div>
    
    <div class="test-section">
        <h2>æ¨¡å—åŠŸèƒ½æµ‹è¯•</h2>
        <div id="function-test-result">æµ‹è¯•ä¸­...</div>
    </div>
    
    <div class="test-section">
        <h2>åº”ç”¨å®ä¾‹æµ‹è¯•</h2>
        <div id="app-test-result">æµ‹è¯•ä¸­...</div>
    </div>

    <div class="test-section">
        <h2>æµ‹è¯•æ—¥å¿—</h2>
        <pre id="test-log"></pre>
    </div>

    <script type="module">
        // æµ‹è¯•æ—¥å¿—è®°å½•
        const testLog = document.getElementById('test-log');
        function log(message) {
            console.log(message);
            testLog.textContent += message + '\n';
        }

        // ES6æ¨¡å—å¯¼å…¥æµ‹è¯•
        async function testES6Import() {
            try {
                log('å¼€å§‹ES6æ¨¡å—å¯¼å…¥æµ‹è¯•...');
                
                // å¯¼å…¥ä¸»æ¨¡å—
                const { 
                    CryptoManager, 
                    TOTPGenerator, 
                    WebDAVClient,
                    LocalStorageManager,
                    QRScanner,
                    PopupManager,
                    SettingManager,
                    popupManager,
                    settingManager
                } = await import('./js/main.js');
                
                log('âœ“ æˆåŠŸå¯¼å…¥æ‰€æœ‰æ¨¡å—ç±»');
                log('âœ“ æˆåŠŸå¯¼å…¥é¢„åˆ›å»ºå®ä¾‹');
                
                document.getElementById('es6-test-result').innerHTML = '<span class="success">âœ“ ES6æ¨¡å—å¯¼å…¥æµ‹è¯•é€šè¿‡</span>';
                
                return {
                    CryptoManager, 
                    TOTPGenerator, 
                    WebDAVClient,
                    LocalStorageManager,
                    QRScanner,
                    PopupManager,
                    SettingManager,
                    popupManager,
                    settingManager
                };
            } catch (error) {
                log('âœ— ES6æ¨¡å—å¯¼å…¥å¤±è´¥: ' + error.message);
                document.getElementById('es6-test-result').innerHTML = '<span class="error">âœ— ES6æ¨¡å—å¯¼å…¥æµ‹è¯•å¤±è´¥</span>';
                throw error;
            }
        }

        // æ¨¡å—åŠŸèƒ½æµ‹è¯•
        async function testModuleFunctions(modules) {
            try {
                log('å¼€å§‹æ¨¡å—åŠŸèƒ½æµ‹è¯•...');
                
                // æµ‹è¯•CryptoManager
                const crypto = new modules.CryptoManager();
                const testData = 'test data';
                const encrypted = await crypto.encrypt(testData);
                const decrypted = await crypto.decrypt(encrypted.data, null, encrypted.salt, encrypted.iv);
                
                if (decrypted === testData) {
                    log('âœ“ CryptoManager åŠ å¯†è§£å¯†æµ‹è¯•é€šè¿‡');
                } else {
                    throw new Error('CryptoManager åŠ å¯†è§£å¯†æµ‹è¯•å¤±è´¥');
                }
                
                // æµ‹è¯•TOTPGenerator
                const totp = new modules.TOTPGenerator();
                const code = totp.generate('JBSWY3DPEHPK3PXP'); // æµ‹è¯•å¯†é’¥
                
                if (code && code.length === 6) {
                    log('âœ“ TOTPGenerator éªŒè¯ç ç”Ÿæˆæµ‹è¯•é€šè¿‡');
                } else {
                    throw new Error('TOTPGenerator éªŒè¯ç ç”Ÿæˆæµ‹è¯•å¤±è´¥');
                }
                
                // æµ‹è¯•LocalStorageManager
                const storage = new modules.LocalStorageManager();
                const testConfig = { 
                    name: 'test', 
                    secret: 'JBSWY3DPEHPK3PXP',
                    issuer: 'TestApp'
                };
                
                await storage.saveConfig(testConfig);
                const configs = await storage.getAllConfigs();
                
                if (configs.length > 0) {
                    log('âœ“ LocalStorageManager å­˜å‚¨æµ‹è¯•é€šè¿‡');
                } else {
                    throw new Error('LocalStorageManager å­˜å‚¨æµ‹è¯•å¤±è´¥');
                }
                
                document.getElementById('function-test-result').innerHTML = '<span class="success">âœ“ æ¨¡å—åŠŸèƒ½æµ‹è¯•é€šè¿‡</span>';
                
            } catch (error) {
                log('âœ— æ¨¡å—åŠŸèƒ½æµ‹è¯•å¤±è´¥: ' + error.message);
                document.getElementById('function-test-result').innerHTML = '<span class="error">âœ— æ¨¡å—åŠŸèƒ½æµ‹è¯•å¤±è´¥</span>';
                throw error;
            }
        }

        // åº”ç”¨å®ä¾‹æµ‹è¯•
        async function testAppInstance() {
            try {
                log('å¼€å§‹åº”ç”¨å®ä¾‹æµ‹è¯•...');
                
                const { default: app } = await import('./js/main.js');
                
                await app.init();
                log('âœ“ åº”ç”¨åˆå§‹åŒ–æˆåŠŸ');
                
                const crypto = app.getManager('crypto');
                const utils = app.getUtils();
                const config = app.getConfig();
                
                if (crypto && utils && config) {
                    log('âœ“ åº”ç”¨å®ä¾‹æ–¹æ³•æµ‹è¯•é€šè¿‡');
                } else {
                    throw new Error('åº”ç”¨å®ä¾‹æ–¹æ³•æµ‹è¯•å¤±è´¥');
                }
                
                document.getElementById('app-test-result').innerHTML = '<span class="success">âœ“ åº”ç”¨å®ä¾‹æµ‹è¯•é€šè¿‡</span>';
                
            } catch (error) {
                log('âœ— åº”ç”¨å®ä¾‹æµ‹è¯•å¤±è´¥: ' + error.message);
                document.getElementById('app-test-result').innerHTML = '<span class="error">âœ— åº”ç”¨å®ä¾‹æµ‹è¯•å¤±è´¥</span>';
                throw error;
            }
        }

        // æ‰§è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            try {
                log('å¼€å§‹æ‰§è¡Œæ¨¡å—ç³»ç»Ÿæµ‹è¯•...\n');
                
                const modules = await testES6Import();
                await testModuleFunctions(modules);
                await testAppInstance();
                
                log('\nğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼æ¨¡å—ç³»ç»Ÿå·¥ä½œæ­£å¸¸ã€‚');
                
            } catch (error) {
                log('\nâŒ æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        // é¡µé¢åŠ è½½åå¼€å§‹æµ‹è¯•
        document.addEventListener('DOMContentLoaded', runAllTests);
    </script>
</body>
</html>
